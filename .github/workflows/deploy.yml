name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run without restarts (dry-run)"
        type: boolean
        default: true
      ref:
        description: "Git ref to deploy (branch name)"
        default: "main"

concurrency:
  group: deploy-main
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Configure known_hosts (recommended)
        if: ${{ secrets.DEPLOY_KNOWN_HOSTS != '' }}
        env:
          DEPLOY_KNOWN_HOSTS: ${{ secrets.DEPLOY_KNOWN_HOSTS }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          printf '%s\n' "$DEPLOY_KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy over SSH
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_KNOWN_HOSTS: ${{ secrets.DEPLOY_KNOWN_HOSTS }}
          DEPLOY_DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || secrets.DEPLOY_DRY_RUN }}
          DEPLOY_REF: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || 'main' }}
          PIPELINE_PATH: /opt/chatos-sync-pipeline
        run: |
          set -euo pipefail

          if [ -z "${DEPLOY_HOST:-}" ] || [ -z "${DEPLOY_USER:-}" ] || [ -z "${DEPLOY_PATH:-}" ]; then
            echo "Missing required deploy secrets (DEPLOY_HOST, DEPLOY_USER, DEPLOY_PATH)."
            exit 1
          fi

          ssh_opts="-o ServerAliveInterval=30 -o ServerAliveCountMax=5"
          if [ -n "${DEPLOY_KNOWN_HOSTS:-}" ]; then
            ssh_opts="$ssh_opts -o StrictHostKeyChecking=yes -o UserKnownHostsFile=$HOME/.ssh/known_hosts"
          else
            ssh_opts="$ssh_opts -o StrictHostKeyChecking=accept-new"
          fi

          remote_env="DEPLOY_PATH='${DEPLOY_PATH}' DEPLOY_REF='${DEPLOY_REF}'"
          if [ -n "${DEPLOY_DRY_RUN:-}" ]; then
            remote_env="$remote_env DEPLOY_DRY_RUN='${DEPLOY_DRY_RUN}'"
          fi

          remote_script="${PIPELINE_PATH}/scripts/deploy_remote.sh"
          ssh $ssh_opts "${DEPLOY_USER}@${DEPLOY_HOST}" "$remote_env bash -lc '"${remote_script}"'"
