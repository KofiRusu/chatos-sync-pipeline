name: CI

on:
  push:
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Shell checks
        shell: bash
        run: |
          set -euo pipefail
          if [ -d "scripts" ] && ls scripts/*.sh >/dev/null 2>&1; then
            bash -n scripts/*.sh
            if command -v shellcheck >/dev/null 2>&1; then
              shellcheck scripts/*.sh
            else
              echo "shellcheck not available; skipping."
            fi
          else
            echo "No shell scripts found; skipping."
          fi

      - name: Detect stack
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          python_present=false
          node_present=false

          if [ -f "src/backend/requirements.txt" ] || [ -f "pyproject.toml" ]; then
            python_present=true
          fi

          if [ -f "src/frontend/package.json" ]; then
            node_present=true
          fi

          echo "python=${python_present}" >> "$GITHUB_OUTPUT"
          echo "node=${node_present}" >> "$GITHUB_OUTPUT"

      - name: Set up Python
        if: steps.detect.outputs.python == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            src/backend/requirements.txt
            requirements-training.txt
            pyproject.toml

      - name: Install Python dependencies
        if: steps.detect.outputs.python == 'true'
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip

          if [ -f "src/backend/requirements.txt" ]; then
            pip install -r src/backend/requirements.txt
          fi

          if [ -f "requirements-training.txt" ]; then
            pip install -r requirements-training.txt
          fi

          ruff_config=false
          if [ -f "pyproject.toml" ] && grep -q "tool.ruff" pyproject.toml; then
            ruff_config=true
          fi
          if [ -f "ruff.toml" ] || [ -f ".ruff.toml" ]; then
            ruff_config=true
          fi

          flake8_config=false
          if [ -f ".flake8" ]; then
            flake8_config=true
          fi
          if [ -f "setup.cfg" ] && grep -q "\[flake8\]" setup.cfg; then
            flake8_config=true
          fi
          if [ -f "tox.ini" ] && grep -q "\[flake8\]" tox.ini; then
            flake8_config=true
          fi

          if [ "$ruff_config" = "true" ]; then
            pip install ruff
          fi

          if [ "$flake8_config" = "true" ]; then
            pip install flake8
          fi

          pytest_config=false
          if [ -d "tests" ]; then
            pytest_config=true
          fi
          if [ -f "pyproject.toml" ] && grep -q "\[tool.pytest.ini_options\]" pyproject.toml; then
            pytest_config=true
          fi

          if [ "$pytest_config" = "true" ]; then
            pip install pytest pytest-asyncio
          fi

      - name: Python checks
        if: steps.detect.outputs.python == 'true'
        shell: bash
        run: |
          set -euo pipefail
          if [ -d "src" ]; then
            python -m compileall -q src
          fi

          if command -v ruff >/dev/null 2>&1; then
            if [ -d "tests" ]; then
              ruff check src tests
            else
              ruff check src
            fi
          fi

          if command -v flake8 >/dev/null 2>&1; then
            flake8
          fi

          if [ -d "tests" ]; then
            pytest
          fi

      - name: Set up Node
        if: steps.detect.outputs.node == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: src/frontend/package-lock.json

      - name: Install Node dependencies
        if: steps.detect.outputs.node == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd src/frontend

          if [ -f "pnpm-lock.yaml" ]; then
            corepack enable
            pnpm install --frozen-lockfile
          elif [ -f "yarn.lock" ]; then
            corepack enable
            yarn install --frozen-lockfile
          elif [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: Node checks
        if: steps.detect.outputs.node == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd src/frontend

          if node -e "const pkg=require('./package.json'); process.exit(pkg.scripts && pkg.scripts.lint ? 0 : 1)"; then
            npm run lint
          else
            echo "No lint script; skipping."
          fi

          if node -e "const pkg=require('./package.json'); process.exit(pkg.scripts && pkg.scripts.build ? 0 : 1)"; then
            npm run build
          else
            echo "No build script; skipping."
          fi

          if node -e "const pkg=require('./package.json'); process.exit(pkg.scripts && pkg.scripts.test ? 0 : 1)"; then
            npm test
          else
            echo "No test script; skipping."
          fi
